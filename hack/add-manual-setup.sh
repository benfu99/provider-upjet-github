#!/bin/bash
# Post-generation script to add manual controller setup

SETUP_FILE="internal/controller/zz_setup.go"

echo "Adding manual controller setup to zz_setup.go..."

# Check if the manual setup call already exists
if grep -q "SetupManual" "$SETUP_FILE"; then
    echo "Manual setup already exists in zz_setup.go"
    exit 0
fi

# Store original file permissions
ORIGINAL_PERMS=$(stat -f "%Mp%Lp" "$SETUP_FILE" 2>/dev/null || stat -c "%a" "$SETUP_FILE" 2>/dev/null || echo "644")

# Create a temporary file with proper line endings
TEMP_FILE=$(mktemp)

# Read the file and add the manual setup before the final return
awk '
/^	return nil$/ && !manual_added {
    print ""
    print "	// MANUAL CONTROLLER SETUP - DO NOT REMOVE"
    print "	// Setup manual controllers that are not generated by upjet"
    print "	if err := SetupManual(mgr, o); err != nil {"
    print "		return err"
    print "	}"
    print "	// END MANUAL CONTROLLER SETUP"
    manual_added = 1
}
{ print }
' "$SETUP_FILE" > "$TEMP_FILE"

# Replace the original file with the temp file to maintain consistent line endings
mv "$TEMP_FILE" "$SETUP_FILE"

# Ensure consistent file permissions (644 - readable/writable by owner, readable by group/others)
chmod 644 "$SETUP_FILE"

echo "Manual controller setup added to zz_setup.go"
